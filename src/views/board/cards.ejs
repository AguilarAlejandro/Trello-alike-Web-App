<%- include('../partials/header.ejs') %>
<%- include('../partials/navbar.ejs') %>
<%- include('../partials/messages.ejs') %>

<div id="card-container">
  <div class="row" id="cardsHeader">
    <div class="col-3">
      <p id="title-text"><strong><%=currentBoard.boardTitle%></strong></p>
    </div>
  </div>


  <% if (JSON.stringify(currentCards)=='[]') { %>
  <div class="row">
    <h1 class="display-4 center">No cards to display</h1>
  </div>
  <div class="row">
    <img src="/images/data-not-found.png" alt="No boards found" class="center">
  </div>

  <% } else { %>

  <div class="row p-1 d-flex justify-content-left" style="margin-left:0px;">
    <ul class="card boardCards list-group" id="cardGroup">
      <% currentCards.forEach( card => { %>
      <li class="list-group-item" data-id="<%=card._id%>">
        <div id="cardHeader">
          <button type="button" class="transparentButton" id="card-title-text" data-toggle="modal"
            data-target="#cardModal" data-title="<%=card.cardTitle%>" data-desc="<%=card.cardDescription%>">
            <p><strong><%=card.cardTitle%></strong></p>
          </button>
          <span>
            <div class="dropdown show">
              <a class="btn" style="color:black;" href="#" role="button" id="optionsMenu"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                ...
              </a>
              <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                <button type="button" class="dropdown-item" data-toggle="modal" data-target="#cardEditModal"
                  data-title="<%=card.cardTitle%>" data-desc="<%=card.cardDescription%>" data-id="<%=card._id%>">
                  Edit
                </button>
                <form action="/board/<%=card.boardId%>/delete/<%=card._id%>?_method=DELETE" method="POST">
                  <input type="hidden" name="method" value="DELETE">
                  <button type="submit" class="dropdown-item" style="color:white; width:100%;">
                    Delete
                  </button>
                </form>
              </div>
            </div>
          </span>
        </div>

        <% card.cardSubtitle.forEach(cardSubtitle => { %>
        <div class="card-text btn my-2" id="cardSubtitles">
          <div id="gonorrea"><%=cardSubtitle%></div>
          <span class="badge">X</span>
        </div>
        <% }) %>
        <button type="button" class="transparentButton" id="newSubButton" data-toggle="modal"
          data-target="#cardSubAddModal" data-id="<%=card._id%>">
          <p class="card-text">Add a new subtitle</p>
        </button>
      </li>

      <!-- Card modal -->
      <div class="modal fade" id="cardModal" tabindex="-1" role="dialog" aria-labelledby="cardModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cardModal"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <h5 class="modal-desc"></h5>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Card edit modal-->
      <div class="modal fade" id="cardEditModal" tabindex="-1" role="dialog" aria-labelledby="cardEditModal"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cardEditModal">Edit <%=card.cardTitle%></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="card text-center">
                <div class="card-body">
                  <form action="/board/<%=card.boardId%>/editcard?_method=PUT" method="post">
                    <div class="input-group mb-3">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Title</span>
                      </div>
                      <input type="text" class="form-control" name="title">
                    </div>
                    <div class="input-group mb-3">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Description</span>
                      </div>
                      <textarea name="description" class="form-control" id="dTextArea"></textarea>
                    </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Save changes</button>
              <input type="hidden" name="currentCardId" id="cCardId">
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- Card subtitle add modal-->
      <div class="modal fade" id="cardSubAddModal" tabindex="-1" role="dialog" aria-labelledby="cardSubAddModal"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="cardSubAddModal">Add a new card subtitle</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <div class="card text-center">
                <div class="card-body">
                  <form action="/board/<%=card.boardId%>/addsubtitle" method="post">
                    <div class="input-group mb-3">
                      <div class="input-group-prepend">
                        <span class="input-group-text">Subtitle</span>
                      </div>
                      <input type="text" class="form-control" name="title" placeholder="Enter card subtitle here">
                    </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary">Add subtitle</button>
              <input type="hidden" name="currentCardId" id="currentId">
              </form>
            </div>
          </div>
        </div>
      </div>
      <%})%>
      <a href="/board/<%=currentBoard._id%>/addcard" style="color:white; text-decoration:none;">
        <div class="card" id="newCardButton">
          <div class="row">
            <div class="col">
              <h1 class="display-6"
                style="text-align:right; position:relative; top:60%; transform: translateY(-60%); left:25%;">
                <i class="fa fa-sticky-note" aria-hidden="true"></i>
              </h1>
            </div>
            <div class="col-8">
              <h1 class="display-4" style="text-align: left; position:relative; top:50%; transform: translateY(-50%);
              font-size: 24px;">New card</h1>
            </div>
          </div>
        </div>
      </a>
    </ul>
    <% } %>
  </div>

</div>
<script>
  //Function that passes the correct card title and description to the modal

  $('#cardModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget)
    var title = button.data('title')
    var desc = button.data('desc')
    var modal = $(this)
    modal.find('.modal-title').text(title)
    modal.find('.modal-desc').text(desc)
  });

  //Function that passes the correct card title and description to the modal edit form

  $('#cardEditModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget)
    var cardId = button.data('id')
    var title = button.data('title')
    var desc = button.data('desc')
    var modal = $(this)
    modal.find('.modal-body input[name="title"]').val(title)
    modal.find('#dTextArea').val(desc)
    modal.find('#cCardId').val(cardId)
  });

  //Function that passes the correct card id to the modal footer hidden variable
  $('#cardSubAddModal').on('show.bs.modal', function (event) {
    var button = $(event.relatedTarget)
    var recipient = button.data('id')
    var modal = $(this)
    modal.find('.modal-footer input').val(recipient)
  })

  const list = document.getElementById("cardGroup");

  Sortable.create(list, {
    group: "card-list",
    animation: 150,
    chosenClass: "selected",
    ghostClass: "ghost",
    dragClass: "drag",
    //Methods
    store: {
      set: (sortable) => { // To save list order
        const cardOrder = sortable.toArray();
        localStorage.setItem(sortable.options.group.name, cardOrder.join('|'));
        $.post('/board/<%=currentBoard._id%>', {
          order: JSON.stringify(localStorage.getItem("card-list").split('|'))
        });
        console.log('From Sortable: ');
        console.log(cardOrder);
      },
    },
  })
</script>

</html>